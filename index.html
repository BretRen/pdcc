<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8" />
    <title>好友聊天系统</title>
    <style>
        /* Reset & Base */
        * {
            box-sizing: border-box;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background-color: #36393f;
            color: #dcddde;
            user-select: none;
        }

        button {
            cursor: pointer;
            border: none;
            background: #7289da;
            color: white;
            border-radius: 4px;
            padding: 6px 12px;
            font-weight: 600;
            transition: background 0.2s ease;
        }

        button:hover {
            background: #5b6eae;
        }

        input {
            background: #202225;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            color: #dcddde;
            font-size: 14px;
            outline: none;
            width: 100%;
        }

        input::placeholder {
            color: #72767d;
        }

        h2 {
            font-weight: 700;
            font-size: 18px;
            margin: 0 0 12px 0;
            padding-left: 12px;
            border-left: 4px solid #7289da;
            user-select: text;
        }

        /* 布局 */
        #app {
            display: flex;
            height: 100vh;
            max-width: 960px;
            margin: 0 auto;
            background-color: #2f3136;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        /* 侧边栏 - 好友列表 */
        #sidebar {
            width: 260px;
            background-color: #202225;
            display: flex;
            flex-direction: column;
            padding: 20px 15px;
        }

        #sidebar h2 {
            color: #b9bbbe;
            border-left: none;
            padding-left: 0;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 16px;
            user-select: text;
        }

        #friendSearchContainer {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        #friendSearchInput {
            flex-grow: 1;
        }

        #friendList {
            flex-grow: 1;
            overflow-y: auto;
            user-select: none;
        }

        .friend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #2f3136;
            margin-bottom: 6px;
            padding: 8px 12px;
            border-radius: 6px;
            color: #b9bbbe;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.15s ease;
            user-select: none;
        }

        .friend-item:hover {
            background-color: #5865f2;
            color: white;
        }

        .friend-item.active {
            background-color: #5865f2;
            color: white;
            font-weight: 700;
        }

        .friend-name {
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .friend-actions {
            display: flex;
            gap: 6px;
            margin-left: 8px;
        }

        .friend-actions button {
            background: transparent;
            color: #f04747;
            padding: 0 6px;
            font-weight: 700;
            font-size: 14px;
            border-radius: 4px;
            user-select: none;
            transition: color 0.15s ease;
        }

        .friend-actions button:hover {
            color: #ff6b6b;
        }

        /* 黑名单展示 */
        #blacklistContainer {
            margin-top: 12px;
            border-top: 1px solid #424549;
            padding-top: 12px;
        }

        #blacklistContainer h3 {
            font-weight: 600;
            font-size: 15px;
            color: #f04747;
            margin-bottom: 8px;
            user-select: text;
        }

        .blacklist-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #2f3136;
            margin-bottom: 6px;
            padding: 8px 12px;
            border-radius: 6px;
            color: #f04747;
            font-size: 14px;
            user-select: none;
        }

        .blacklist-name {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .blacklist-actions button {
            background: transparent;
            color: #43b581;
            padding: 0 6px;
            font-weight: 700;
            font-size: 14px;
            border-radius: 4px;
            user-select: none;
            transition: color 0.15s ease;
        }

        .blacklist-actions button:hover {
            color: #6ee3b4;
        }

        /* 主要内容区 */
        #main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: #36393f;
            padding: 20px;
        }

        #chatHeader {
            border-bottom: 1px solid #2f3136;
            padding-bottom: 8px;
            margin-bottom: 12px;
            font-weight: 700;
            font-size: 20px;
            color: #fff;
            user-select: text;
        }

        #chatMessages {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 10px;
            scroll-behavior: smooth;
            user-select: text;
        }

        .message {
            margin-bottom: 14px;
            display: flex;
            gap: 12px;
        }

        .message .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #7289da;
            color: white;
            font-weight: 700;
            font-size: 18px;
            text-align: center;
            line-height: 40px;
            user-select: none;
            flex-shrink: 0;
        }

        .message-content {
            max-width: 80%;
            word-wrap: break-word;
        }

        .message-username {
            font-weight: 600;
            color: #fff;
            margin-bottom: 4px;
            user-select: text;
        }

        .message-text {
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #dcddde;
        }

        /* 系统消息 */
        .system-message {
            text-align: center;
            margin: 16px 0;
            color: #888;
            font-size: 14px;
            font-weight: 500;
            user-select: none;
        }

        .system-divider {
            border-top: 1px solid #555;
            margin: 4px 0;
        }

        .system-text {
            margin: 4px 0;
            color: #aaa;
        }

        /* 请求通知 */
        .request-notification {
            background: #2f3136;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 3px solid #7289da;
        }

        .request-actions {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }

        .request-actions button {
            flex: 1;
            padding: 5px;
        }

        /* 输入区域 */
        #chatInputContainer {
            margin-top: 12px;
            display: flex;
            gap: 10px;
        }

        #chatInput {
            flex-grow: 1;
            padding: 10px 14px;
            font-size: 14px;
            border-radius: 6px;
            border: none;
            background-color: #40444b;
            color: #dcddde;
            outline: none;
            user-select: text;
        }

        #sendButton {
            padding: 0 20px;
            background-color: #5865f2;
            border-radius: 6px;
            font-weight: 700;
            transition: background-color 0.2s ease;
            user-select: none;
        }

        #sendButton:hover {
            background-color: #4752c4;
        }

        /* 登录遮罩 */
        #loginModal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            user-select: none;
        }

        #loginBox {
            background: #2f3136;
            padding: 30px 40px;
            border-radius: 10px;
            width: 320px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            color: #ddd;
        }

        #loginBox h2 {
            margin-top: 0;
            color: #fff;
            text-align: center;
            user-select: text;
        }

        #loginBox input {
            margin-bottom: 15px;
            user-select: text;
        }

        #serverSelect {
            user-select: text;
        }
    </style>
</head>

<body>
    <!-- 登录遮罩 -->
    <div id="loginModal">
        <div id="loginBox">
            <h2 id="modalTitle">登录好友聊天系统</h2>

            <select id="serverSelect" style="width: 100%; margin-bottom: 10px; padding: 8px; border-radius: 4px;">
                <option value="local">本地服务器</option>
                <option value="main">主服务器</option>
                <option value="custom">自定义服务器</option>
            </select>
            <input id="customServerInput" placeholder="ws://地址:端口" style="display:none; margin-bottom: 10px;" />

            <input id="loginUsername" placeholder="用户名" autocomplete="off" />
            <input id="loginPassword" type="password" placeholder="密码" autocomplete="off" />

            <div style="display:flex; gap:10px; justify-content:center;">
                <button id="loginBtn" style="flex-grow:1;">登录</button>
                <button id="registerBtn" style="flex-grow:1;">注册</button>
            </div>

            <p id="loginStatus" style="color:#f04747; height: 18px; margin-top: 8px; text-align: center;"></p>
        </div>
    </div>

    <!-- 主界面 -->
    <div id="app" style="display:none;">
        <div id="sidebar">
            <h2>好友列表</h2>
            <div id="friendSearchContainer">
                <input id="friendSearchInput" placeholder="输入用户名或UID添加好友…" />
                <button id="addFriendBtn" title="添加好友">添加</button>
            </div>
            <div id="friendList"></div>

            <div id="blacklistContainer" style="display:none;">
                <h3>黑名单</h3>
                <div id="blacklist"></div>
            </div>
        </div>

        <div id="main">
            <div id="chatHeader">请选择好友聊天</div>
            <div id="chatMessages"></div>
            <div id="chatInputContainer" style="display:none;">
                <input id="chatInput" placeholder="输入消息…" />
                <button id="sendButton">发送</button>
            </div>
        </div>
    </div>

    <script>
        // 常量
        const CLIENT_VERSION = "2.0.0";

        // UI 元素
        const loginModal = document.getElementById('loginModal');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const loginUsername = document.getElementById('loginUsername');
        const loginPassword = document.getElementById('loginPassword');
        const loginStatus = document.getElementById('loginStatus');

        const serverSelect = document.getElementById('serverSelect');
        const customServerInput = document.getElementById('customServerInput');

        const app = document.getElementById('app');
        const friendListEl = document.getElementById('friendList');
        const friendSearchInput = document.getElementById('friendSearchInput');
        const addFriendBtn = document.getElementById('addFriendBtn');

        const blacklistContainer = document.getElementById('blacklistContainer');
        const blacklistEl = document.getElementById('blacklist');

        const chatHeader = document.getElementById('chatHeader');
        const chatMessages = document.getElementById('chatMessages');
        const chatInputContainer = document.getElementById('chatInputContainer');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');

        // WebSocket 连接和用户信息
        let socket = null;
        let currentUser = null; // { id, username }
        let currentChatFriend = null; // { id, username }
        let friends = []; // [id]
        let blacklist = []; // [id]
        let pendingRequests = []; // [id]
        let uidToUsernameMap = new Map();

        // 显示或隐藏自定义服务器输入框
        serverSelect.addEventListener('change', () => {
            customServerInput.style.display = serverSelect.value === 'custom' ? 'block' : 'none';
        });

        // 添加系统消息
        function addSystemMessage(text) {
            const systemDiv = document.createElement('div');
            systemDiv.classList.add('system-message');

            const line1 = document.createElement('div');
            line1.classList.add('system-divider');

            const messageLine = document.createElement('div');
            messageLine.classList.add('system-text');
            messageLine.textContent = text;

            const line2 = document.createElement('div');
            line2.classList.add('system-divider');

            systemDiv.appendChild(line1);
            systemDiv.appendChild(messageLine);
            systemDiv.appendChild(line2);

            chatMessages.appendChild(systemDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 添加好友请求通知
        function addFriendRequestNotification(fromId, fromName) {
            const notificationDiv = document.createElement('div');
            notificationDiv.classList.add('request-notification');

            const textDiv = document.createElement('div');
            textDiv.textContent = `${fromName} 想添加你为好友`;

            const actionsDiv = document.createElement('div');
            actionsDiv.classList.add('request-actions');

            const acceptBtn = document.createElement('button');
            acceptBtn.textContent = '同意';
            acceptBtn.onclick = () => {
                socket.send(JSON.stringify({
                    type: 'respond_friend_request',
                    fromId: fromId,
                    accept: true
                }));
                notificationDiv.remove();
            };

            const rejectBtn = document.createElement('button');
            rejectBtn.textContent = '拒绝';
            rejectBtn.onclick = () => {
                socket.send(JSON.stringify({
                    type: 'respond_friend_request',
                    fromId: fromId,
                    accept: false
                }));
                notificationDiv.remove();
            };

            actionsDiv.appendChild(acceptBtn);
            actionsDiv.appendChild(rejectBtn);

            notificationDiv.appendChild(textDiv);
            notificationDiv.appendChild(actionsDiv);

            chatMessages.appendChild(notificationDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 添加普通消息
        function addChatMessage(user, text, isSelf = false) {
            if (!user || !text) return;

            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message');
            if (isSelf) {
                msgDiv.style.justifyContent = 'flex-end';
                msgDiv.style.flexDirection = 'row-reverse';
            }

            const avatar = document.createElement('div');
            avatar.classList.add('avatar');
            avatar.textContent = user[0].toUpperCase();

            const contentDiv = document.createElement('div');
            contentDiv.classList.add('message-content');

            const userSpan = document.createElement('div');
            userSpan.classList.add('message-username');
            userSpan.textContent = user;

            const textSpan = document.createElement('div');
            textSpan.classList.add('message-text');
            textSpan.textContent = text;

            contentDiv.appendChild(userSpan);
            contentDiv.appendChild(textSpan);
            msgDiv.appendChild(avatar);
            msgDiv.appendChild(contentDiv);

            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 重置登录界面
        function resetToLogin(reason) {
            currentUser = null;
            currentChatFriend = null;
            socket = null;
            friends = [];
            blacklist = [];
            pendingRequests = [];
            uidToUsernameMap.clear();

            chatMessages.innerHTML = '';
            chatInputContainer.style.display = 'none';
            chatHeader.textContent = '请选择好友聊天';
            friendListEl.innerHTML = '';
            blacklistEl.innerHTML = '';
            blacklistContainer.style.display = 'none';

            loginModal.style.display = 'flex';
            app.style.display = 'none';

            loginStatus.style.color = '#f04747';
            loginStatus.textContent = reason || '与服务端断开连接，请重新登录';
        }

        // 连接WebSocket
        function connectWebSocket(onOpenCallback) {
            let wsAddress;
            if (serverSelect.value === 'main') {
                wsAddress = "ws://98.142.241.143:12345";
            } else if (serverSelect.value === 'local') {
                wsAddress = "ws://localhost:12345";
            } else {
                wsAddress = customServerInput.value.trim();
                if (!wsAddress) {
                    loginStatus.textContent = '请输入自定义服务器地址';
                    return false;
                }
            }

            socket = new WebSocket(wsAddress);

            socket.onopen = () => {
                addSystemMessage('已连接服务器');
                onOpenCallback();
            };

            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('接收数据', data);

                switch (data.type) {
                    case 'login':
                        if (data.success) {
                            loginStatus.style.color = '#43b581';
                            loginStatus.textContent = '登录成功！';

                            currentUser = {
                                id: data.uid,
                                username: data.username,
                            };

                            // 更新用户名映射
                            if (data.usernameMap) {
                                Object.entries(data.usernameMap).forEach(([id, username]) => {
                                    uidToUsernameMap.set(parseInt(id), username);
                                });
                            }

                            // 更新好友列表和黑名单
                            friends = data.friends || [];
                            pendingRequests = data.pendingRequests || [];
                            blacklist = data.blacklist || [];

                            // 渲染界面
                            renderFriendList();
                            renderBlacklist();

                            loginModal.style.display = 'none';
                            app.style.display = 'flex';
                            chatHeader.textContent = '请选择好友聊天';

                            // 如果有待处理的好友请求，显示通知
                            if (pendingRequests.length > 0) {
                                addSystemMessage(`你有 ${pendingRequests.length} 个待处理的好友请求`);
                            }

                        } else {
                            loginStatus.style.color = '#f04747';
                            loginStatus.textContent = data.error || '登录失败';
                        }
                        break;

                    case 'register':
                        if (data.success) {
                            loginStatus.style.color = '#43b581';
                            loginStatus.textContent = '注册成功！请登录。';
                        } else {
                            loginStatus.style.color = '#f04747';
                            loginStatus.textContent = data.error || '注册失败';
                        }
                        break;

                    case 'friend_request':
                        addFriendRequestNotification(data.fromId, data.fromName);
                        break;

                    case 'friend_added':
                        if (!friends.includes(data.friendId)) {
                            friends.push(data.friendId);
                        }
                        uidToUsernameMap.set(data.friendId, data.friendName);
                        renderFriendList();
                        addSystemMessage(`你与 ${data.friendName} 已成为好友`);
                        break;

                    case 'friend_removed':
                        friends = friends.filter(id => id !== data.friendId);
                        if (currentChatFriend && currentChatFriend.id === data.friendId) {
                            currentChatFriend = null;
                            chatMessages.innerHTML = '';
                            chatInputContainer.style.display = 'none';
                            chatHeader.textContent = '请选择好友聊天';
                        }
                        renderFriendList();
                        addSystemMessage(`已删除好友：${uidToUsernameMap.get(data.friendId) || data.friendId}`);
                        break;

                    case 'blacklist_added':
                        if (!blacklist.includes(data.blockedId)) {
                            blacklist.push(data.blockedId);
                        }
                        uidToUsernameMap.set(data.blockedId, data.blockedName);
                        renderBlacklist();
                        addSystemMessage(`已加入黑名单：${data.blockedName}`);
                        break;

                    case 'blacklist_removed':
                        blacklist = blacklist.filter(id => id !== data.blockedId);
                        renderBlacklist();
                        addSystemMessage(`已从黑名单移除：${uidToUsernameMap.get(data.blockedId) || data.blockedId}`);
                        break;

                    case 'chat_history':
                        if (data.friendId === (currentChatFriend && currentChatFriend.id)) {
                            chatMessages.innerHTML = '';
                            if (data.history && data.history.length) {
                                data.history.forEach(msg => {
                                    const isSelf = msg.fromId === currentUser.id;
                                    const username = uidToUsernameMap.get(msg.fromId) || `用户${msg.fromId}`;
                                    addChatMessage(username, msg.text, isSelf);
                                });
                            } else {
                                addSystemMessage('暂无聊天记录');
                            }
                        }
                        break;

                    case 'message':
                        const { fromId, toId, text } = data;
                        const friendId = currentChatFriend && currentChatFriend.id;
                        if (friendId && (fromId === friendId || toId === friendId)) {
                            const isSelf = fromId === currentUser.id;
                            const senderName = uidToUsernameMap.get(fromId) || `用户${fromId}`;
                            addChatMessage(senderName, text, isSelf);
                        } else {
                            // 不是当前聊天好友的消息可以考虑显示通知或忽略
                            addSystemMessage(`收到来自${uidToUsernameMap.get(fromId) || `用户${fromId}`}的新消息`);
                        }
                        break;

                    case 'message_sent':
                        // 消息发送成功的确认，可以在这里处理
                        break;

                    case 'usernames':
                        // 更新用户名映射
                        Object.entries(data.map).forEach(([id, username]) => {
                            uidToUsernameMap.set(parseInt(id), username);
                        });
                        // 重新渲染可能需要更新的列表
                        renderFriendList();
                        renderBlacklist();
                        break;

                    case 'error':
                        addSystemMessage(`错误：${data.message}`);
                        break;

                    default:
                        console.warn('未知消息类型', data.type);
                }
            };

            socket.onclose = () => {
                resetToLogin('服务器断开连接');
            };

            socket.onerror = (err) => {
                console.error('WebSocket错误', err);
                loginStatus.textContent = 'WebSocket连接错误';
            };

            return true;
        }

        // 渲染好友列表
        function renderFriendList() {
            friendListEl.innerHTML = '';

            if (friends.length === 0) {
                friendListEl.innerHTML = '<p style="color:#72767d; padding: 12px;">好友列表为空</p>';
                return;
            }

            friends.forEach(id => {
                const friendName = uidToUsernameMap.get(id) || `用户${id}`;
                const friendItem = document.createElement('div');
                friendItem.className = 'friend-item';
                if (currentChatFriend && currentChatFriend.id === id) friendItem.classList.add('active');

                const nameDiv = document.createElement('div');
                nameDiv.className = 'friend-name';
                nameDiv.textContent = `${friendName} (${id})`;

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'friend-actions';

                // 删除好友按钮
                const delBtn = document.createElement('button');
                delBtn.textContent = '删除';
                delBtn.title = '删除好友';
                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (confirm(`确定删除好友【${friendName}】吗？`)) {
                        socket.send(JSON.stringify({
                            type: 'remove_friend',
                            friendId: id,
                        }));
                    }
                };

                // 加入黑名单按钮
                const blackBtn = document.createElement('button');
                blackBtn.textContent = '拉黑';
                blackBtn.title = '加入黑名单';
                blackBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (confirm(`确定将【${friendName}】加入黑名单吗？`)) {
                        socket.send(JSON.stringify({
                            type: 'block',
                            userId: id,
                        }));
                    }
                };

                actionsDiv.appendChild(delBtn);
                actionsDiv.appendChild(blackBtn);

                friendItem.appendChild(nameDiv);
                friendItem.appendChild(actionsDiv);

                friendItem.onclick = () => {
                    if (currentChatFriend && currentChatFriend.id === id) return; // 已选中
                    currentChatFriend = { id, username: friendName };
                    chatHeader.textContent = `与【${friendName}】聊天`;
                    chatMessages.innerHTML = '';
                    chatInputContainer.style.display = 'flex';

                    // 请求聊天记录
                    socket.send(JSON.stringify({
                        type: 'chat_history',
                        friendId: id,
                    }));

                    renderFriendList();
                };

                friendListEl.appendChild(friendItem);
            });
        }

        // 渲染黑名单列表
        function renderBlacklist() {
            if (blacklist.length === 0) {
                blacklistContainer.style.display = 'none';
                return;
            }
            blacklistContainer.style.display = 'block';
            blacklistEl.innerHTML = '';

            blacklist.forEach(id => {
                const name = uidToUsernameMap.get(id) || `用户${id}`;
                const item = document.createElement('div');
                item.className = 'blacklist-item';

                const nameDiv = document.createElement('div');
                nameDiv.className = 'blacklist-name';
                nameDiv.textContent = `${name} (${id})`;

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'blacklist-actions';

                // 移除黑名单按钮
                const removeBtn = document.createElement('button');
                removeBtn.textContent = '解除';
                removeBtn.title = '移除黑名单';
                removeBtn.onclick = () => {
                    if (confirm(`确定将【${name}】从黑名单移除吗？`)) {
                        socket.send(JSON.stringify({
                            type: 'unblock',
                            userId: id,
                        }));
                    }
                };

                actionsDiv.appendChild(removeBtn);

                item.appendChild(nameDiv);
                item.appendChild(actionsDiv);

                blacklistEl.appendChild(item);
            });
        }

        // 发送消息
        function sendMessage() {
            if (!currentChatFriend) {
                alert('请先选择好友聊天');
                return;
            }
            const text = chatInput.value.trim();
            if (!text) return;

            socket.send(JSON.stringify({
                type: 'message',
                toId: currentChatFriend.id,
                text,
            }));

            // 自己消息立即显示
            addChatMessage(currentUser.username, text, true);
            chatInput.value = '';
        }

        // 发送好友请求
        function sendFriendRequest() {
            const input = friendSearchInput.value.trim();
            if (!input) return;

            socket.send(JSON.stringify({
                type: 'send_friend_request',
                identifier: input,
            }));

            friendSearchInput.value = '';
            addSystemMessage('好友请求已发送');
        }

        // 登录函数
        function doLogin() {
            const username = loginUsername.value.trim();
            const password = loginPassword.value.trim();

            if (!username || !password) {
                loginStatus.textContent = '请输入用户名和密码';
                return;
            }

            if (!connectWebSocket(() => {
                // 连接成功后发送登录请求
                socket.send(JSON.stringify({
                    type: 'login',
                    username,
                    password,
                    version: CLIENT_VERSION,
                }));
            })) {
                // 连接失败处理
                loginStatus.textContent = 'WebSocket连接失败';
            }
        }

        // 注册函数
        function doRegister() {
            const username = loginUsername.value.trim();
            const password = loginPassword.value.trim();

            if (!username || !password) {
                loginStatus.textContent = '请输入用户名和密码';
                return;
            }

            if (!connectWebSocket(() => {
                // 连接成功后发送注册请求
                socket.send(JSON.stringify({
                    type: 'register',
                    username,
                    password,
                    version: CLIENT_VERSION,
                }));
            })) {
                loginStatus.textContent = 'WebSocket连接失败';
            }
        }

        // 添加好友按钮点击
        addFriendBtn.onclick = sendFriendRequest;

        // 发送消息按钮点击
        sendButton.onclick = sendMessage;

        // 输入框回车发送消息
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // 登录和注册按钮事件绑定
        loginBtn.onclick = doLogin;
        registerBtn.onclick = doRegister;

        // 页面加载默认聚焦用户名输入框
        window.onload = () => {
            loginUsername.focus();
        };
    </script>
</body>

</html>